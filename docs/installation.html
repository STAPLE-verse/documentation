<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Installation Guide – STAPLE Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./glossary.html" rel="next">
<link href="./core-concepts.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="glossary/glossary.css">
</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./installation.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Installation Guide</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">STAPLE Documentation</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core-concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Core Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./installation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Installation Guide</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Glossary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">References</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link active" data-scroll-target="#assumptions"><span class="header-section-number">4.1</span> Assumptions</a></li>
  <li><a href="#local-development-or-hosting" id="toc-local-development-or-hosting" class="nav-link" data-scroll-target="#local-development-or-hosting"><span class="header-section-number">4.2</span> Local Development or Hosting</a></li>
  <li><a href="#installation-steps" id="toc-installation-steps" class="nav-link" data-scroll-target="#installation-steps"><span class="header-section-number">4.3</span> Installation Steps</a>
  <ul class="collapse">
  <li><a href="#web-server-installation" id="toc-web-server-installation" class="nav-link" data-scroll-target="#web-server-installation"><span class="header-section-number">4.3.1</span> Web Server Installation</a></li>
  <li><a href="#blitzjs-installation" id="toc-blitzjs-installation" class="nav-link" data-scroll-target="#blitzjs-installation"><span class="header-section-number">4.3.2</span> Blitz/JS Installation</a></li>
  <li><a href="#clone-the-repository" id="toc-clone-the-repository" class="nav-link" data-scroll-target="#clone-the-repository"><span class="header-section-number">4.3.3</span> Clone the Repository</a></li>
  <li><a href="#database-installation" id="toc-database-installation" class="nav-link" data-scroll-target="#database-installation"><span class="header-section-number">4.3.4</span> Database Installation</a></li>
  <li><a href="#connect-database-to-staple-app" id="toc-connect-database-to-staple-app" class="nav-link" data-scroll-target="#connect-database-to-staple-app"><span class="header-section-number">4.3.5</span> Connect Database to STAPLE App</a></li>
  <li><a href="#configure-email" id="toc-configure-email" class="nav-link" data-scroll-target="#configure-email"><span class="header-section-number">4.3.6</span> Configure Email</a></li>
  <li><a href="#install-staple-requirements" id="toc-install-staple-requirements" class="nav-link" data-scroll-target="#install-staple-requirements"><span class="header-section-number">4.3.7</span> Install STAPLE Requirements</a></li>
  <li><a href="#starting-the-app---local-testing" id="toc-starting-the-app---local-testing" class="nav-link" data-scroll-target="#starting-the-app---local-testing"><span class="header-section-number">4.3.8</span> Starting the App - Local Testing</a></li>
  <li><a href="#starting-the-app---production" id="toc-starting-the-app---production" class="nav-link" data-scroll-target="#starting-the-app---production"><span class="header-section-number">4.3.9</span> Starting the App - Production</a></li>
  <li><a href="#keeping-the-app-going" id="toc-keeping-the-app-going" class="nav-link" data-scroll-target="#keeping-the-app-going"><span class="header-section-number">4.3.10</span> Keeping the App Going</a></li>
  <li><a href="#setting-up-the-proxy-nginx" id="toc-setting-up-the-proxy-nginx" class="nav-link" data-scroll-target="#setting-up-the-proxy-nginx"><span class="header-section-number">4.3.11</span> Setting Up the Proxy (Nginx)</a></li>
  <li><a href="#enable-https" id="toc-enable-https" class="nav-link" data-scroll-target="#enable-https"><span class="header-section-number">4.3.12</span> Enable HTTPS</a></li>
  </ul></li>
  <li><a href="#common-issues-fixes" id="toc-common-issues-fixes" class="nav-link" data-scroll-target="#common-issues-fixes"><span class="header-section-number">4.4</span> Common Issues &amp; Fixes</a>
  <ul class="collapse">
  <li><a href="#prisma-database-errors" id="toc-prisma-database-errors" class="nav-link" data-scroll-target="#prisma-database-errors"><span class="header-section-number">4.4.1</span> Prisma / Database Errors</a></li>
  <li><a href="#build-errors" id="toc-build-errors" class="nav-link" data-scroll-target="#build-errors"><span class="header-section-number">4.4.2</span> Build Errors</a></li>
  <li><a href="#email-issues" id="toc-email-issues" class="nav-link" data-scroll-target="#email-issues"><span class="header-section-number">4.4.3</span> Email Issues</a></li>
  <li><a href="#nginx-proxy-issues" id="toc-nginx-proxy-issues" class="nav-link" data-scroll-target="#nginx-proxy-issues"><span class="header-section-number">4.4.4</span> Nginx / Proxy Issues</a></li>
  <li><a href="#service-issues" id="toc-service-issues" class="nav-link" data-scroll-target="#service-issues"><span class="header-section-number">4.4.5</span> Service Issues</a></li>
  <li><a href="#general-tips" id="toc-general-tips" class="nav-link" data-scroll-target="#general-tips"><span class="header-section-number">4.4.6</span> General Tips</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Installation Guide</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>STAPLE is available as a hosted service at https://app.staple.science, which is the simplest way to get started.</p>
<p>This guide is for individuals or organizations who would like to host their own instance of STAPLE. Running your own version gives you full control over your data, configuration, and integration with your existing infrastructure.</p>
<section id="assumptions" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="assumptions"><span class="header-section-number">4.1</span> Assumptions</h2>
<p>This guide assumes you meet the following prerequisites:</p>
<ul>
<li>You are working on a Linux server. We use Ubuntu 20.04 in this guide, but the steps should be consistent for most Linux distributions.</li>
<li>You have shell/terminal access to the server.</li>
<li>You have worked with the command line before.</li>
<li>You have <code>sudo</code> privileges to install packages and manage services.</li>
<li>You understand what hidden files are (and how to view them).</li>
<li>You have a basic understanding of SQL and databases (familiarity with PostgreSQL is not required).</li>
<li>You know what Apache and/or Nginx servers are and how to edit their configuration files.</li>
<li>You can imagine yourself using git (even if you’re new to it).</li>
</ul>
</section>
<section id="local-development-or-hosting" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="local-development-or-hosting"><span class="header-section-number">4.2</span> Local Development or Hosting</h2>
<p>You can also run STAPLE locally on your own computer, with a few limitations.</p>
<ul>
<li>If you are using a Linux system, you can follow the same instructions described in this guide from Blitz/JS Installation through Starting the App – Production.</li>
<li>On Windows, you can run STAPLE as well, but you’ll need to use a shell environment (such as PowerShell, Git Bash, or WSL2) to follow the same command-line instructions.</li>
<li>On macOS, the setup is nearly identical to Linux, and you can use the standard Terminal application to run the commands.</li>
</ul>
<p>When running locally, you will be the only user able to enter data. The application is not hosted on the web, so others will not be able to connect.</p>
<p>Despite this limitation, you will still have access to the full functionality of project management and metadata entry/output. This makes local installation useful for:</p>
<ul>
<li>Testing the system before deploying to a server</li>
<li>Exploring functionality on your own</li>
<li>Managing personal projects without a shared server</li>
</ul>
</section>
<section id="installation-steps" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="installation-steps"><span class="header-section-number">4.3</span> Installation Steps</h2>
<section id="web-server-installation" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="web-server-installation"><span class="header-section-number">4.3.1</span> Web Server Installation</h3>
<p>STAPLE requires a web server to handle requests. You can choose between <strong>Apache</strong> or <strong>Nginx</strong>:</p>
<ul>
<li><p><strong>Apache</strong> – <a href="https://ubuntu.com/tutorials/install-and-configure-apache">Installation Instructions</a></p></li>
<li><p><strong>Nginx</strong> – <a href="https://ubuntu.com/tutorials/install-and-configure-nginx">Installation Instructions</a></p></li>
</ul>
<blockquote class="blockquote">
<p>⚠️ Important: Only install one. Apache and Nginx don’t play nicely together if they’re both running on the same server.</p>
</blockquote>
<p>We recommend using <strong>Nginx</strong>, and our production server is configured with Nginx. This step is only required for people who want to host the software online. You do not need it for local development or use.</p>
</section>
<section id="blitzjs-installation" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="blitzjs-installation"><span class="header-section-number">4.3.2</span> Blitz/JS Installation</h3>
<p>STAPLE is built with <strong>Blitz.js</strong>, which runs on Node.js. To install the required tools:</p>
<ul>
<li>Install Node.js and npm
<ul>
<li>Follow the official installation instructions: <a href="https://nodejs.org/en/download">Node.js Downloads</a></li>
<li>Required versions:
<ul>
<li><strong>Node.js</strong>: v18+</li>
<li><strong>npm</strong>: v9+</li>
</ul></li>
<li>Verify installation with:</li>
</ul></li>
</ul>
<pre><code>node -v
npm -v</code></pre>
<ul>
<li>(Optional) Yarn: You may use Yarn if you prefer, but this guide assumes <strong>npm</strong>.</li>
<li>Install Blitz.js
<ul>
<li>Run:</li>
</ul></li>
</ul>
<pre><code>npm install -g blitz</code></pre>
<ul>
<li>Verify installation (version <strong>v2+</strong> required):</li>
</ul>
<pre><code>blitz -v</code></pre>
<blockquote class="blockquote">
<p>ℹ️ Note: Depending on your server setup, you may need to prepend commands with <code>sudo</code>.</p>
</blockquote>
</section>
<section id="clone-the-repository" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="clone-the-repository"><span class="header-section-number">4.3.3</span> Clone the Repository</h3>
<p>Next, you’ll need to copy the STAPLE source code onto your server.</p>
<ul>
<li>Install Git (if not already installed):</li>
</ul>
<pre><code>sudo apt-get update
sudo apt-get install git</code></pre>
<ul>
<li>Navigate to your web directory (commonly <code>/var/www/html/</code> or <code>/var/www/</code>):</li>
<li><em>Note</em>: you can use any folder on your computer if you are not hosting the software online or want to do local development.</li>
</ul>
<pre><code>cd /var/www/html/</code></pre>
<ul>
<li>Clone the repository:
<ul>
<li>Follow the <a href="https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository">GitHub guide</a> on cloning repositories.
<ul>
<li>Or simply run:</li>
</ul></li>
</ul></li>
</ul>
<pre><code>git clone https://github.com/STAPLE-verse/STAPLE.git</code></pre>
<ul>
<li>This will create a new folder named STAPLE containing all the files you need.</li>
<li>Move into the project folder:</li>
</ul>
<pre><code>cd STAPLE</code></pre>
</section>
<section id="database-installation" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="database-installation"><span class="header-section-number">4.3.4</span> Database Installation</h3>
<p>STAPLE requires a PostgreSQL database.</p>
<ul>
<li>Install PostgreSQL
<ul>
<li>Ensure that you have a local PostgreSQL service running.</li>
<li>Follow this guide for installation: <a href="https://www.prisma.io/dataguide/postgresql/setting-up-a-local-postgresql-database">Postgres Setup Instructions</a>.</li>
<li>During installation:
<ul>
<li>Write down the superuser credentials (important on non-Linux systems).</li>
<li>Other databases may work, but you would need to modify the STAPLE codebase to support them.</li>
</ul></li>
</ul></li>
<li>Create Databases
<ul>
<li>Open a terminal and run:</li>
</ul></li>
</ul>
<pre><code># Switch into PostgreSQL as the postgres superuser
sudo -u postgres psql

# Create databases for STAPLE
CREATE DATABASE staple;
CREATE DATABASE staple_test;</code></pre>
<ul>
<li>Create a User
<ul>
<li>It’s best not to use the default postgres user for STAPLE. Instead, create a new user:</li>
<li>Replace username and password with your desired values (keep the quotes).</li>
</ul></li>
</ul>
<pre><code>CREATE USER username WITH PASSWORD 'password';
ALTER ROLE username CREATEDB;</code></pre>
<ul>
<li>Check Databases
<ul>
<li>Inside the PostgreSQL prompt, you can verify:</li>
</ul></li>
</ul>
<pre><code>\l   -- lists databases
\c staple   -- connect to the STAPLE database
\dn  -- lists schemas</code></pre>
<ul>
<li>You should see something like the following using those commands:</li>
</ul>
<pre><code>postgres=# \c staple
You are now connected to database "staple" as user "postgres".
staple=# </code></pre>
<pre><code>staple=# \dn
 List of schemas
  Name  | Owner  
--------+--------
 public | staple
(1 row)

staple=# </code></pre>
<pre><code>postgres=# \l
                                     List of databases
    Name     |  Owner   | Encoding |   Collate   |    Ctype    |     Access privileges     
-------------+----------+----------+-------------+-------------+---------------------------
 postgres    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 staple      | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =Tc/postgres             +
             |          |          |             |             | postgres=CTc/postgres    +
             |          |          |             |             | staple=CTc/postgres      +
             |          |          |             |             | staple_admin=CTc/postgres
 staple_test | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0   | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres              +
             |          |          |             |             | postgres=CTc/postgres
 template1   | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres              +
             |          |          |             |             | postgres=CTc/postgres
(5 rows)</code></pre>
<ul>
<li>Grant Privileges
<ul>
<li>Finally, grant permissions for your new user to manage the staple schema:</li>
</ul></li>
</ul>
<pre><code>GRANT ALL ON SCHEMA public TO username;</code></pre>
<ul>
<li>Exit PostgreSQL using <code>\q</code></li>
</ul>
</section>
<section id="connect-database-to-staple-app" class="level3" data-number="4.3.5">
<h3 data-number="4.3.5" class="anchored" data-anchor-id="connect-database-to-staple-app"><span class="header-section-number">4.3.5</span> Connect Database to STAPLE App</h3>
<ul>
<li>Now we’ll connect the PostgreSQL database you created to the STAPLE application.</li>
<li>Navigate to your STAPLE project folder</li>
</ul>
<pre><code>cd /var/www/html/STAPLE
ls -al</code></pre>
<ul>
<li>You should see a file named <code>.env</code> along with other project files.</li>
<li>You may need to enable hidden files to see .env files.</li>
<li>Example:</li>
</ul>
<pre><code>erin@staple:/var/www/html/STAPLE$ ls -al
total 764
drwxr-xr-x  13 root root   4096 Oct 24 06:17 .
drwxr-xr-x   6 root root   4096 Oct 24 05:02 ..
drwxr-xr-x   3 root root   4096 Oct 24 04:27 db
-rw-r--r--   1 root root    175 Oct 24 04:27 .editorconfig
-rw-r--r--   1 root root    494 Oct 24 06:17 .env</code></pre>
<ul>
<li>Create a local environment file
<ul>
<li>Copy the .env file and rename it to .env.local:</li>
</ul></li>
</ul>
<pre><code>cp .env .env.local</code></pre>
<pre><code>- Open it for editing:</code></pre>
<pre><code>nano .env.local</code></pre>
<ul>
<li>Add required environment variables
<ul>
<li>At minimum, your .env.local file needs these:</li>
</ul></li>
</ul>
<pre><code># This env file should NOT be checked into source control
# Use this file for local overrides

# Replace username:password with your Postgres user and password
DATABASE_URL=postgresql://username:password@localhost:5432/staple

# Generate a random session key
SESSION_SECRET_KEY=your_generated_session_key

# Where the app will live
APP_ORIGIN="http://localhost:3000/"</code></pre>
<ul>
<li>To generate a SESSION_SECRET_KEY:
<ul>
<li>Copy the output and paste it in place of your_generated_session_key.</li>
</ul></li>
</ul>
<pre><code>openssl rand -hex 16</code></pre>
<ul>
<li>Set up a test environment
<ul>
<li>Copy .env.test to .env.test.local:</li>
</ul></li>
</ul>
<pre><code>cp .env.test .env.test.local</code></pre>
<ul>
<li>Edit it to point to your test database:</li>
</ul>
<pre><code>DATABASE_URL=postgresql://username:password@localhost:5432/staple_test</code></pre>
</section>
<section id="configure-email" class="level3" data-number="4.3.6">
<h3 data-number="4.3.6" class="anchored" data-anchor-id="configure-email"><span class="header-section-number">4.3.6</span> Configure Email</h3>
<p>STAPLE requires an email provider to send system emails (e.g., password resets, project invitations). You can use other options here, but we’ve configured three of them in our current code.</p>
<section id="secret-keys" class="level4" data-number="4.3.6.1">
<h4 data-number="4.3.6.1" class="anchored" data-anchor-id="secret-keys"><span class="header-section-number">4.3.6.1</span> Secret Keys</h4>
<ul>
<li><p>You must configure at least one of the following options:</p></li>
<li><p>Gmail (App Passwords)</p>
<ul>
<li>Create a Gmail App Password: Google Guide</li>
<li>Add to .env.local:</li>
</ul></li>
</ul>
<pre><code>EMAIL_PASS="your_app_password"</code></pre>
<ul>
<li>Amazon SES
<ul>
<li>Set up Amazon Simple Email Service (SES): Amazon SES Docs</li>
<li>Add to .env.local:</li>
</ul></li>
</ul>
<pre><code>ACCESS_KEY="amazonACCESS"
SECRET_ACCESS_KEY="amazonSECRET"</code></pre>
<ul>
<li>Resend
<ul>
<li>Get an API key from Resend.</li>
<li>Add to .env.local:</li>
</ul></li>
</ul>
<pre><code>RESEND_API_KEY="resendAPI"</code></pre>
</section>
<section id="edit-the-mailer-configuration" class="level4" data-number="4.3.6.2">
<h4 data-number="4.3.6.2" class="anchored" data-anchor-id="edit-the-mailer-configuration"><span class="header-section-number">4.3.6.2</span> Edit the Mailer Configuration</h4>
<p>In addition to adding one of the above environment variables, you’ll need to edit the mailer configuration file so STAPLE knows which provider to use.</p>
<ul>
<li>Open the mailer configuration file:</li>
</ul>
<pre><code>nano integrations/mailer.js</code></pre>
<ul>
<li><p>Delete non-used mailers: there are three chunks of code in this file - one for each type of email. You should delete the types you are not using to ensure the app runs. You can also insert your own mail options in this section.</p></li>
<li><p>Edit the forgot password mailer:</p></li>
</ul>
<pre><code>nano mailers/forgotPasswordMailer.ts</code></pre>
<ul>
<li>Change these sections to the mailer you want to use:</li>
</ul>
<pre><code>// import { Mailer } from "integrations/mailer"
import { createForgotPasswordMsg } from "integrations/emails"
// import { Amazon } from "integrations/mailer"
import { ResendMsg } from "integrations/mailer"</code></pre>
<pre><code>//send the email
await ResendMsg(createForgotPasswordMsg(to, resetUrl))
// await Amazon(createForgotPasswordMsg(to, resetUrl)) # or amazon
// await Mailer(createForgotPasswordMsg(to, resetUrl)) # or gmail</code></pre>
<ul>
<li>Edit the emails.tsx file if you want to customize the emails that are sent with your own email address and logos.</li>
</ul>
<pre><code>nano integrations/emails.tsx</code></pre>
</section>
</section>
<section id="install-staple-requirements" class="level3" data-number="4.3.7">
<h3 data-number="4.3.7" class="anchored" data-anchor-id="install-staple-requirements"><span class="header-section-number">4.3.7</span> Install STAPLE Requirements</h3>
<ul>
<li>Make sure you are in the STAPLE main folder before running these commands.</li>
<li>Use the following (not the <code>#</code> line, these are notes) to install packages, tailwind, and daisyui.</li>
</ul>
<pre><code># Install all project dependencies
npm install

# Install Tailwind CSS
blitz install tailwind

# Install DaisyUI
npm i -D daisyui@latest</code></pre>
<ul>
<li>Set up the database schema:</li>
</ul>
<pre><code># Generate Prisma client
blitz prisma generate

# Run migrations to create database structure
blitz prisma migrate dev</code></pre>
</section>
<section id="starting-the-app---local-testing" class="level3" data-number="4.3.8">
<h3 data-number="4.3.8" class="anchored" data-anchor-id="starting-the-app---local-testing"><span class="header-section-number">4.3.8</span> Starting the App - Local Testing</h3>
<ul>
<li>Open a terminal window and navigate to the STAPLE folder you cloned:</li>
</ul>
<pre><code>cd /var/www/html/STAPLE</code></pre>
<ul>
<li>Start the development server:</li>
</ul>
<pre><code>blitz dev</code></pre>
<ul>
<li>Once the server is running, open your browser and go to: http://localhost:3000 (or whatever address is shown in your terminal output).</li>
</ul>
</section>
<section id="starting-the-app---production" class="level3" data-number="4.3.9">
<h3 data-number="4.3.9" class="anchored" data-anchor-id="starting-the-app---production"><span class="header-section-number">4.3.9</span> Starting the App - Production</h3>
<ul>
<li>Open a terminal window and navigate to the STAPLE folder you cloned:</li>
</ul>
<pre><code>cd /var/www/html/STAPLE</code></pre>
<ul>
<li>Build the application:</li>
</ul>
<pre><code>blitz build</code></pre>
<blockquote class="blockquote">
<p>⚠️ Note: If the build process produces errors, you’ll need to fix these before you can continue. Common issues include missing dependencies or mismatched Prisma client versions. Check the terminal output for details. We do not update our dev or main branches without fixing these, but it may be that your edits for your server caused hiccups.</p>
</blockquote>
<ul>
<li>Once the build completes successfully, start the app in production mode:</li>
</ul>
<pre><code>blitz start</code></pre>
</section>
<section id="keeping-the-app-going" class="level3" data-number="4.3.10">
<h3 data-number="4.3.10" class="anchored" data-anchor-id="keeping-the-app-going"><span class="header-section-number">4.3.10</span> Keeping the App Going</h3>
<p>When running in production, you’ll want STAPLE to automatically restart after crashes or reboots. The recommended way to do this on Linux is by creating a systemd service.</p>
<ul>
<li>Create a service file
<ul>
<li>Navigate to the systemd directory and create a new file (we’ll call it <code>blitz.service</code>):</li>
</ul></li>
</ul>
<pre><code>cd /etc/systemd/system/
sudo nano blitz.service</code></pre>
<ul>
<li>Example service file:
<ul>
<li>Replace <code>WorkingDirectory</code> with the path to your STAPLE installation.</li>
<li>You can also set specific users or production modes for security.</li>
</ul></li>
</ul>
<pre><code>[Unit]
Description=Starts the Blitz service.
After=network.target

[Service]
Type=simple
WorkingDirectory=/var/www/html/STAPLE
ExecStart=/usr/local/bin/blitz start
Restart=always

[Install]
WantedBy=default.target</code></pre>
<ul>
<li>Enable and control the service
<ul>
<li>Once your file is saved, you can manage it with:</li>
</ul></li>
</ul>
<pre><code># Start the service
sudo systemctl start blitz  

# Check status (press "q" to quit)
sudo systemctl status blitz  

# Restart the service
sudo systemctl restart blitz  

# Stop the service
sudo systemctl stop blitz  

# Enable service on boot
sudo systemctl enable blitz  

# Disable service
sudo systemctl disable blitz  

# Reset if failed
sudo systemctl reset-failed blitz  </code></pre>
<ul>
<li>Tutorial reference
<ul>
<li>If you’re new to systemd services, see this helpful guide: <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-a-linux-service-to-start-automatically-after-a-crash-or-reboot-part-1-practical-examples">Service Installation Instructions</a></li>
</ul></li>
</ul>
</section>
<section id="setting-up-the-proxy-nginx" class="level3" data-number="4.3.11">
<h3 data-number="4.3.11" class="anchored" data-anchor-id="setting-up-the-proxy-nginx"><span class="header-section-number">4.3.11</span> Setting Up the Proxy (Nginx)</h3>
<p>Now that STAPLE is running as a background service, you’ll want to expose it through your web domain with Nginx.</p>
<ul>
<li>Navigate to your Nginx configuration folder</li>
</ul>
<pre><code>cd /etc/nginx/sites-enabled</code></pre>
<ul>
<li>Create a new site config file
<ul>
<li>Name it after your site, e.g.:</li>
</ul></li>
</ul>
<pre><code>sudo nano app.staple.science</code></pre>
<ul>
<li>Add the server configuration
<ul>
<li>Replace app.staple.science with your domain and update the log path if needed:</li>
</ul></li>
</ul>
<pre><code>server {
    listen 80;
    server_name app.staple.science;

    error_log /var/www/html/YOURFOLDER/logs/web-server.log;

    location / {
        proxy_pass http://localhost:3000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}</code></pre>
<blockquote class="blockquote">
<p>⚠️ Important: Make sure the server_name matches your domain name, and the proxy_pass points to the port where Blitz is running (localhost:3000 by default).</p>
</blockquote>
<ul>
<li>Test your config:</li>
</ul>
<pre><code>sudo nginx -t</code></pre>
<ul>
<li>If you see syntax is ok and test is successful, reload Nginx:</li>
</ul>
<pre><code>sudo systemctl reload nginx</code></pre>
</section>
<section id="enable-https" class="level3" data-number="4.3.12">
<h3 data-number="4.3.12" class="anchored" data-anchor-id="enable-https"><span class="header-section-number">4.3.12</span> Enable HTTPS</h3>
<ul>
<li>Use Let’s Encrypt to add SSL by changing the location of your app in the following:</li>
</ul>
<pre><code>sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d app.staple.science</code></pre>
<ul>
<li>This will automatically configure HTTPS and renew your certificate.</li>
<li>See <a href="https://certbot.eff.org/">Installation Instructions</a>.</li>
</ul>
</section>
</section>
<section id="common-issues-fixes" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="common-issues-fixes"><span class="header-section-number">4.4</span> Common Issues &amp; Fixes</h2>
<section id="prisma-database-errors" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="prisma-database-errors"><span class="header-section-number">4.4.1</span> Prisma / Database Errors</h3>
<ul>
<li>Error: Error: P1000: Authentication failed against database server
<ul>
<li>Fix: Double-check your DATABASE_URL in .env.local. Make sure the username/password match the Postgres user you created.</li>
</ul></li>
<li>Error: Error: P3014: The underlying table does not exist
<ul>
<li>Fix: Run migrations again:</li>
</ul></li>
</ul>
<pre><code>blitz prisma migrate dev</code></pre>
<ul>
<li>Permission denied when running migrations
<ul>
<li>Fix: Ensure the Postgres user has privileges:</li>
</ul></li>
</ul>
<pre><code>ALTER ROLE your_username CREATEDB;
GRANT ALL ON SCHEMA public TO your_username;</code></pre>
</section>
<section id="build-errors" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="build-errors"><span class="header-section-number">4.4.2</span> Build Errors</h3>
<ul>
<li>Error: blitz build fails with missing dependencies
<ul>
<li>Fix: Run npm install again to ensure all dependencies are installed.</li>
</ul></li>
<li>Prisma client mismatch
<ul>
<li>Fix: Run:</li>
</ul></li>
</ul>
<pre><code>blitz prisma generate</code></pre>
</section>
<section id="email-issues" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="email-issues"><span class="header-section-number">4.4.3</span> Email Issues</h3>
<ul>
<li>No emails are being sent
<ul>
<li>Fix: Check that you kept only one mailer provider in mailer.ts.</li>
<li>Ensure the correct environment variables (EMAIL_PASS, ACCESS_KEY, SECRET_ACCESS_KEY, or RESEND_API_KEY) are set in .env.local.</li>
<li>For Amazon SES, make sure your MAIL_FROM address is verified.</li>
<li>For Gmail, use an App Password, not your regular password.</li>
</ul></li>
</ul>
</section>
<section id="nginx-proxy-issues" class="level3" data-number="4.4.4">
<h3 data-number="4.4.4" class="anchored" data-anchor-id="nginx-proxy-issues"><span class="header-section-number">4.4.4</span> Nginx / Proxy Issues</h3>
<ul>
<li>Nginx won’t start
<ul>
<li>Fix: Run <code>sudo nginx -t</code> to test configuration. Correct any syntax errors before restarting.</li>
</ul></li>
<li>Site loads, but app doesn’t respond
<ul>
<li>Fix: Make sure blitz is running (check with <code>sudo systemctl status blitz</code>).</li>
<li>Check that the <code>proxy_pass</code> in your Nginx config matches the Blitz port (localhost:3000 by default).</li>
</ul></li>
<li>SSL certificate not working
<ul>
<li>Fix: Ensure port 80/443 are open on your firewall.</li>
<li>Re-run certbot:</li>
</ul></li>
</ul>
<pre><code>sudo certbot --nginx -d yourdomain.com</code></pre>
</section>
<section id="service-issues" class="level3" data-number="4.4.5">
<h3 data-number="4.4.5" class="anchored" data-anchor-id="service-issues"><span class="header-section-number">4.4.5</span> Service Issues</h3>
<ul>
<li>Blitz doesn’t restart after reboot
<ul>
<li>Fix: Make sure the service is enabled:</li>
</ul></li>
</ul>
<pre><code>sudo systemctl enable blitz</code></pre>
<ul>
<li>Service crashes with permission errors
<ul>
<li>Fix: Ensure the User in <code>blitz.service</code> has read/write access to the STAPLE folder.</li>
</ul></li>
</ul>
</section>
<section id="general-tips" class="level3" data-number="4.4.6">
<h3 data-number="4.4.6" class="anchored" data-anchor-id="general-tips"><span class="header-section-number">4.4.6</span> General Tips</h3>
<ul>
<li>After editing .env.local, .env.test.local, or blitz.service, restart the app:</li>
</ul>
<pre><code>sudo systemctl restart blitz</code></pre>
<ul>
<li>Check logs:</li>
</ul>
<pre><code>journalctl -u blitz -f</code></pre>
<p>Get help: contact <a href="mailto:staple.helpdesk@gmail.com">staple.helpdesk at gmail.com</a>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./core-concepts.html" class="pagination-link" aria-label="Core Concepts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Core Concepts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./glossary.html" class="pagination-link" aria-label="Glossary">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Glossary</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>